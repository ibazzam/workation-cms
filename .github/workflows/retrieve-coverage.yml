name: Retrieve Coverage Summary

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # daily at 02:00 UTC

jobs:
  retrieve:
    name: Retrieve and compute coverage summary
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run retrieve_and_compute
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.COVERAGE_FETCH_PAT }}
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          # configure git identity so commits succeed in the runner
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          # set origin to use the provided PAT for pushes
          git remote set-url origin "https://x-access-token:${{ secrets.COVERAGE_FETCH_PAT }}@github.com/ibazzam/workation-cms.git"
          # ensure script content is available (avoid sparse-checkout issues)
          git fetch --no-tags origin main
          git show origin/main:scripts/retrieve_and_compute.ps1 > .\retrieve_and_compute.ps1
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\retrieve_and_compute.ps1 -Owner ibazzam -Repo workation-cms

      - name: Upload coverage summary via GitHub REST API
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.COVERAGE_FETCH_PAT }}
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          $owner = 'ibazzam'
          $repo = 'workation-cms'
          $branch = 'coverage-reports'
          # find the generated summary file
          $file = Get-ChildItem -Path $PWD -Recurse -Filter 'coverage-summary-ci.json' -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $file) { Write-Host 'No coverage-summary-ci.json found; skipping upload.'; exit 0 }
          $contentBytes = [System.IO.File]::ReadAllBytes($file.FullName)
          $encoded = [Convert]::ToBase64String($contentBytes)
          $apiBase = "https://api.github.com/repos/$owner/$repo"
          $headers = @{ Authorization = "token $($env:GITHUB_TOKEN)"; Accept = 'application/vnd.github+json'; 'User-Agent' = 'coverage-uploader' }

          # ensure branch exists; create from main if missing
          $refUrl = "$apiBase/git/refs/heads/$branch"
          try {
            Invoke-RestMethod -Uri $refUrl -Headers $headers -Method Get -ErrorAction Stop | Out-Null
            Write-Host "Branch $branch exists."
          } catch {
            Write-Host "Branch $branch not found; creating from main..."
            $mainRef = Invoke-RestMethod -Uri "$apiBase/git/refs/heads/main" -Headers $headers -Method Get
            $mainSha = $mainRef.object.sha
            $body = @{ ref = "refs/heads/$branch"; sha = $mainSha } | ConvertTo-Json
            Invoke-RestMethod -Uri "$apiBase/git/refs" -Headers $headers -Method Post -Body $body -ContentType 'application/json'
            Write-Host "Created branch $branch."
          }

          # check if file exists to get sha
          $contentsUrl = "$apiBase/contents/coverage-reports/coverage-summary-ci.json?ref=$branch"
          $existing = $null
          try { $existing = Invoke-RestMethod -Uri $contentsUrl -Headers $headers -Method Get -ErrorAction Stop } catch { }

          $msg = "ci: add coverage summary (generated $(Get-Date -Format o))"
          $putBody = @{ message = $msg; content = $encoded; branch = $branch }
          if ($existing) { $putBody.sha = $existing.sha }
          $putBodyJson = $putBody | ConvertTo-Json
          Invoke-RestMethod -Uri "$apiBase/contents/coverage-reports/coverage-summary-ci.json" -Headers $headers -Method Put -Body $putBodyJson -ContentType 'application/json'
          Write-Host 'Uploaded coverage summary via REST API.'

          # create a Shields-compatible badge JSON and upload it as well
          $summaryDecoded = $putBody.content
          try {
            $summaryResp = Invoke-RestMethod -Uri "$apiBase/contents/coverage-reports/coverage-summary-ci.json?ref=$branch" -Headers $headers -Method Get -ErrorAction Stop
            $summaryContent = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($summaryResp.content)) | ConvertFrom-Json
            $pct = $summaryContent.percent.statements
            $color = if ($pct -ge 90) { 'brightgreen' } elseif ($pct -ge 75) { 'yellow' } else { 'red' }
            $badgeObj = @{ schemaVersion = 1; label = 'coverage'; message = "$pct%"; color = $color }
            $badgeJson = ($badgeObj | ConvertTo-Json -Compress)
            $badgeEncoded = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($badgeJson))
            $badgeBody = @{ message = "coverage badge"; content = $badgeEncoded; branch = $branch }
            $existingBadge = $null
            try { $existingBadge = Invoke-RestMethod -Uri "$apiBase/contents/coverage-reports/coverage-badge.json?ref=$branch" -Headers $headers -Method Get -ErrorAction Stop } catch { }
            if ($existingBadge) { $badgeBody.sha = $existingBadge.sha }
            $badgeBodyJson = $badgeBody | ConvertTo-Json
            Invoke-RestMethod -Uri "$apiBase/contents/coverage-reports/coverage-badge.json" -Headers $headers -Method Put -Body $badgeBodyJson -ContentType 'application/json'
            Write-Host 'Uploaded coverage badge JSON.'
          } catch {
            Write-Host 'Failed to generate/upload badge JSON:' $_.Exception.Message
          }
